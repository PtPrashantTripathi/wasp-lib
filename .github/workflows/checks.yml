name: Lint & Test on PR

on:
    pull_request:
        branches:
            - main
            - develop
            - feature/*

jobs:
    lint-test:
        name: Lint and Test
        runs-on: ubuntu-latest
        permissions: # ðŸ‘ˆ Needed for PR comment
            contents: read
            pull-requests: write

        steps:
            # Checkout the repository
            - name: Checkout Repository
              uses: actions/checkout@v4

            # Set up Node.js
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "latest"

            # Install and activate Emscripten SDK (if required for wasm build)
            - name: Install and Activate Emscripten SDK
              run: |
                  git clone https://github.com/emscripten-core/emsdk.git ~/emsdk
                  ~/emsdk/emsdk install latest
                  ~/emsdk/emsdk activate latest
                  source ~/emsdk/emsdk_env.sh
                  npm run build:wasm
              shell: bash

            # Install dependencies
            - name: Install Node dependencies
              run: npm install

            # Run lint
            - name: Run lint
              run: npm run lint

            # Run tests with coverage
            - name: Run tests
              run: npm run test:coverage

            # Upload coverage artifacts (optional, for debugging or downloads)
            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage

            # Comment coverage summary in PR
            - name: Report coverage in PR
              uses: davelosert/vitest-coverage-report-action@v2
              with:
                  json-summary-path: coverage/coverage-summary.json
                  json-final-path: coverage/coverage-final.json
